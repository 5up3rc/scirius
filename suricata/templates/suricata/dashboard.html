{% load  staticfiles %}
{% load bootstrap3  %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>{% block title %}Scirius - {{ path_info|title }}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
     <!-- Latest compiled and minified CSS -->
     <link rel="stylesheet" href="{% static 'rules/bootstrap.min.css' %}" />
     <link rel="stylesheet" href="{% static 'rules/nv.d3.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'django_tables2/themes/paleblue/css/screen.css' %}"/>
    <link rel="shortcut icon" href="{% static 'rules/favicon.ico' %}" />
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/d3.v3.min.js' %}" charset="utf-8"></script>
    <script src="{% static 'js/nv.d3.js' %}" charset="utf-8"></script>
    <script type="text/javascript" src="{% static 'js/scirius.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/tipsy.js' %}"></script>
    {% block head %} {% endblock %}
    <link rel="stylesheet" type="text/css" href="{% static 'rules/static.css' %}" />
</head>


<body> 
<meta charset="utf-8">
<style>

.link {
  stroke-opacity: 0.6;
}

.node circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

</style>

<div class="container-fluid">
<div class="row">
<div class="col-md-12">
<form class="form" method="post">
{% csrf_token %}
			<span class="glyphicon glyphicon-search"> Filter: <input type="text" name="filter" id="id_filter" {% if filter %}value="{{ filter }}" {% endif %} width="20" /></span>
</form>

<span class="pull-right">
Last {{ date }} 
<a  class="dropdown-toggle" type="button" id="display_menu" data-toggle="dropdown">
<span class="glyphicon glyphicon-cog"> </span>
</a>
<ul class="dropdown-menu" id="display_menu">
   <li><a href="?duration=1">Last 1h</a></li>
   <li><a href="?duration=6">Last 6h</a></li>
   <li><a href="?duration=24">Last 24h</a></li>
   <li><a href="?duration=48">Last 2d</a></li>
   <li><a href="?duration=168">Last 7d</a></li>
</ul>
</span>

</div>
</div>

<div class="row">
<div class="col-md-6">
<h2 class="title">IP addresses linked by alerts</h3>
<div  style="border:solid 1px #ccc; border-radius: 4px;" >
<svg width="750" height="750" id="alerts"></svg>
<div id="highlight_info">
</div>
</div>
</div>
<div class="col-md-6">
<div class="container-fluid">
<div class="row">
<div class="col-md-12">
<h2 class="title">Alert infos</h3>

<div id="timeline">
<p>Fetching data...</p>
<svg style="width:100%;height:300px">
</svg>
</div>
</div>
</div>

<div class="row">
<div class="col-md-12">
<h2 class="title">Rules activity</h2>


<div id="rules_table">Fetching data...</div>

</div>

</div>
</div>
</div>

<script>

$( 'document' ).ready(function () { draw_timeline({{ from_date }}, [{% autoescape off %} {{ probes|join:',' }} {% endautoescape %}], "{{ filter }}"); });
{% if filter and not filter == "*" %}
$( 'document' ).ready(load_rules({{ from_date }},  [ '*' ], "{{ filter }}"));
{% else %}
$( 'document' ).ready(load_rules({{ from_date }},  [ '*' ], null));
{% endif %}

function draw_ippair_alerts(from_date, hosts, filter, callback) {
    esurl = "/rules/es?query=ippair_alerts&from_date=" + from_date + "&hosts=" + hosts.join()
    if (filter) {
        esurl = esurl + "&filter=" + filter;
    }
    $.ajax(
     {
     type:"GET",
     url:esurl,
     success: function(json) {
        if (json == null) {
            $("#alerts").append("No data to build the graph");
            return;
        }

        var svg = d3.select("svg#alerts"),
            width = +svg.attr("width"),
            height = +svg.attr("height");
        
        var color = d3.scale.category20b();
        
        var force = d3.layout.force()
            .gravity(0.03)
            .distance(50)
            .charge(-50)
            .size([width, height]);
        
        json = JSON.parse(json);
        force
          .nodes(json.nodes)
          .links(json.links)
          .start();

        var link = svg.selectAll(".link")
            .data(json.links)
          .enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", function(d) { return d.value; })
            .attr("stroke", "#999");

        link.append("title").text(function(d) {
        var title="";
        for (var i = 0; i < d.alerts.length; i++) {
          title = title + d.alerts[i]['key'] + ": " + d.alerts[i]['doc_count'] + "\n";
        }
        return title;
        });

        var node = svg.selectAll(".node")
            .data(json.nodes)
          .enter().append("g")
            .attr("class", "node")
          .append("circle")
          .attr("r", 7)
          .attr("fill", function(d) { return color(d.group * 10); })
          .call(force.drag);
      
        node.append("title")
            .text(function(d) { return d.id; });
      
        force.on("tick", function() {
          link.attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });
      
          node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        });

        var i = 0;
        setInterval(function() {
            link = json.links[i];
            /* d3.selectAll("circle").data(json.nodes).transition().duration(750).attr("r", function(d) { if (d.id == json.links[i].source.id || d.id == json.links[i].target.id) return 14; return 7; }); */
            text = "<ul><li>Source: "  + json.links[i].source.id + "</li><li>Target: " + json.links[i].target.id + "</li>"
            text = text + "<li>Alerts: <ul>";
            d = json.links[i];
            for (var j = 0; j < d.alerts.length; j++) {
                text = text + "<li>" + d.alerts[j]['key'] + ": " + d.alerts[j]['doc_count'] + "</li>";
            }
            text = text + "</ul></li>";
            $("#highlight_info").empty();
            $("#highlight_info").append(text);
            d3.selectAll("circle").data(json.nodes).attr("r", function(d) { if (d.id == json.links[i].source.id || d.id == json.links[i].target.id) return 14; return 7; });	
            d3.selectAll("line").data(json.links).attr("stroke", function(d) { if (d == json.links[i]) return "red"; return "#999"; });	
            i++;
            if (i >= json.links.length) {
                i = 0;
            }
        }
        , 3000);

      }
      });
}


$( 'document' ).ready(function () { draw_ippair_alerts({{ from_date }}, [{% autoescape off %} {{ probes|join:',' }} {% endautoescape %}], "{{ filter }}"); });
</script>

</body>
</html>
